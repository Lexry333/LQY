<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>作品集 | Portfolio</title>
    <style>
        /* 基础重置 & 性能优化 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-drag: none;
            -webkit-tap-highlight-color: transparent;
            tap-highlight-color: transparent;
        }

        /* 高端动态背景 - 粒子渐变+景深效果 */
        body {
            background: radial-gradient(circle at 50% 50%, #121826, #050811);
            min-height: 100vh;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            overflow-x: hidden;
            color: #fff;
            position: relative;
        }
        
        /* 粒子背景画布 - 电脑端默认显示，手机端默认隐藏 */
        body canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
            pointer-events: none;
            opacity: 0.7;
            display: block; /* 恢复电脑端粒子显示 */
        }

        /* 顶部标题栏 - 简约高端 */
        .header {
            position: relative;
            z-index: 10;
            text-align: center;
            padding: 2rem 1rem;
            margin-bottom: 1rem;
        }
        
        .header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(120deg, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 0.5rem;
        }
        
        .header .subtitle {
            color: #a0aec0;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
            line-height: 1.5;
        }
        
        .header .subtitle-en {
            color: #718096;
            font-size: 0.85rem;
            letter-spacing: 0.3px;
            margin-top: 0.2rem;
        }

        /* 核心：沉浸式网格画廊（替代滚轮列表） */
        .gallery-container {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem 3rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        /* 网格项 - 修复点击区域问题 */
        .gallery-container .gallery-item {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transform: translateY(0);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            position: relative;
            /* 确保点击区域完整 */
            touch-action: manipulation;
            -webkit-touch-callout: none;
        }
        
        /* 防盗水印层 */
        .gallery-container .gallery-item::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGl0bGU+5bm/5pyN5Lq6PC90aXRsZT48dGV4dCB4PSIzMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiNmZmYvMzAwIj7nlLXorr7orr7mlL/nlYw8L3RleHQ+PC9zdmc+") repeat;
            background-size: 120px;
            opacity: 0.12;
            pointer-events: none;
            z-index: 1;
        }
        
        /* 悬停效果 - 只在电脑端生效 */
        @media (min-width: 769px) {
            .gallery-container .gallery-item:hover {
                transform: translateY(-8px) scale(1.02);
                box-shadow: 0 16px 48px rgba(0, 191, 255, 0.2);
            }
        }
        
        /* 图片容器 - 确保点击穿透 */
        .gallery-container .gallery-item .gallery-img-wrapper {
            width: 100%;
            height: 220px;
            overflow: hidden;
            position: relative;
            pointer-events: none; /* 让点击穿透到父元素 */
        }
        
        /* 加载动画 */
        .gallery-container .gallery-item .gallery-img-wrapper.loading::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            margin: -15px 0 0 -15px;
            border: 2px solid rgba(79, 172, 254, 0.3);
            border-radius: 50%;
            border-top-color: #4facfe;
            animation: spin 1s linear infinite;
            z-index: 2;
        }
        
        /* 图片样式 */
        .gallery-container .gallery-item .gallery-img-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform-origin: center;
            transition: transform 0.3s ease;
            filter: blur(1px);
            pointer-events: none; /* 确保点击穿透 */
        }
        
        .gallery-container .gallery-item .gallery-img-wrapper img.loaded {
            filter: none;
        }
        
        /* 作品标题 - 扩大点击区域 */
        .gallery-container .gallery-item .item-title {
            padding: 1rem;
            font-size: 1rem;
            font-weight: 500;
            color: #e2e8f0;
            background: linear-gradient(to bottom, transparent, rgba(17, 24, 39, 0.8));
            pointer-events: none; /* 点击穿透 */
        }

        /* 全屏预览模式 */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 8, 17, 0.98);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
            touch-action: none;
        }
        
        /* 预览图片容器 */
        .preview-modal .preview-img-container {
            width: 90%;
            max-width: 1200px;
            height: 80vh;
            overflow: hidden;
            position: relative;
            margin-bottom: 1rem;
        }
        
        /* 预览图片 */
        .preview-modal .preview-img-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            cursor: grab;
            transform-origin: center;
            transition: transform 0.02s linear;
        }
        
        .preview-modal .preview-img-container img:active {
            cursor: grabbing;
        }
        
        /* 导航控制栏 */
        .preview-modal .preview-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 90%;
            max-width: 1200px;
            margin-top: 1rem;
        }
        
        /* 翻页按钮 */
        .preview-modal .preview-controls .nav-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(79, 172, 254, 0.2);
            color: #fff;
            border: 1px solid rgba(79, 172, 254, 0.4);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-modal .preview-controls .nav-btn:hover {
            background: rgba(79, 172, 254, 0.4);
            transform: scale(1.05);
        }
        
        .preview-modal .preview-controls .nav-btn:disabled {
            opacity: 0.2;
            cursor: not-allowed;
            transform: none;
        }
        
        /* 页码指示器 */
        .preview-modal .preview-controls .page-indicator {
            color: #a0aec0;
            font-size: 0.9rem;
        }
        
        .preview-modal .preview-controls .page-indicator span {
            color: #4facfe;
            font-weight: 600;
        }
        
        /* 关闭按钮 */
        .preview-modal .preview-controls .close-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(248, 113, 113, 0.2);
            color: #fff;
            border: 1px solid rgba(248, 113, 113, 0.4);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-modal .preview-controls .close-btn:hover {
            background: rgba(248, 113, 113, 0.4);
            transform: scale(1.05);
        }
        
        /* 预览提示语 */
        .preview-modal .preview-tip {
            position: absolute;
            top: 2rem;
            color: #a0aec0;
            font-size: 0.9rem;
            background: rgba(17, 24, 39, 0.7);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            pointer-events: none;
            line-height: 1.5;
        }
        
        .preview-modal .preview-tip-en {
            font-size: 0.8rem;
            color: #90a0b7;
            margin-top: 0.2rem;
        }

        /* 动画定义 */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 响应式适配 - 重点优化移动端 */
        @media (max-width: 768px) {
            /* 手机端隐藏粒子动画（节省性能） */
            body canvas {
                display: none !important;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            .gallery-container {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 0.8rem;
            }
            .gallery-container .gallery-item .gallery-img-wrapper {
                height: 150px;
            }
            .preview-modal .preview-img-container {
                width: 95%;
                height: 60vh;
            }
            .preview-modal .preview-controls .nav-btn, 
            .preview-modal .preview-controls .close-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            .preview-modal .preview-tip {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
        }

        /* 强制隐藏右键菜单（防盗） */
        [oncontextmenu] {
            pointer-events: auto !important;
        }
    </style>
    <!-- 预加载字体提升性能 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
</head>

<!-- 全维度防盗 -->
<body oncontextmenu="return false" onselectstart="return false" ondragstart="return false" oncopy="return false" oncut="return false" onpaste="return false">
    <!-- 粒子背景画布 -->
    <canvas id="particleCanvas"></canvas>

    <!-- 顶部标题栏 -->
    <div class="header">
        <h1>作品集</h1>
        <p class="subtitle">点击图片查看 | 滚轮缩放 | 拖拽移动
            <span class="subtitle-en">Click to view | Scroll to zoom | Drag to move</span>
        </p>
    </div>

    <!-- 核心：沉浸式网格画廊 -->
    <div class="gallery-container" id="galleryContainer">
        <!-- 画廊项由JS动态生成 -->
    </div>

    <!-- 全屏预览模态框 -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-tip">←→ 切换 | ESC 关闭 | 滚轮缩放 | 拖拽移动
            <div class="preview-tip-en">←→ Switch | ESC Close | Scroll to zoom | Drag to move</div>
        </div>
        <div class="preview-img-container" id="previewImgContainer">
            <img src="" id="previewImg" alt="作品" class="portfolio-img">
        </div>
        <div class="preview-controls">
            <button class="nav-btn prev-btn" id="prevBtn">←</button>
            <div class="page-indicator">作品 <span id="currentPageNum">1</span> / <span id="totalPageNum">7</span></div>
            <button class="nav-btn next-btn" id="nextBtn">→</button>
            <button class="close-btn" id="closeBtn">×</button>
        </div>
    </div>

    <script>
        // ====================== 基础常量定义 ======================
        // 1. 区分移动端/桌面端
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // 2. 作品数据
        const imgList = [
            { src: "111.jpg", thumbSrc: "111_thumb.jpg", title: "1" },
            { src: "2025-1.jpg", thumbSrc: "2025-1_thumb.jpg", title: "2" },
            { src: "2025.jpg", thumbSrc: "2025_thumb.jpg", title: "3" },
            { src: "4.jpg", thumbSrc: "4_thumb.jpg", title: "4" },
            { src: "3.jpg", thumbSrc: "3_thumb.jpg", title: "5" },
            { src: "2.jpg", thumbSrc: "2_thumb.jpg", title: "6" },
            { src: "1.jpg", thumbSrc: "1_thumb.jpg", title: "7" }
        ];
        
        let currentIndex = 0;
        const imgStates = {};
        
        // 初始化图片状态
        imgList.forEach((_, index) => {
            imgStates[index] = { scale: 1, x: 0, y: 0 };
        });

        // ====================== DOM元素获取 ======================
        const galleryContainer = document.getElementById('galleryContainer');
        const previewModal = document.getElementById('previewModal');
        const previewImg = document.getElementById('previewImg');
        const previewImgContainer = document.getElementById('previewImgContainer');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const closeBtn = document.getElementById('closeBtn');
        const currentPageNum = document.getElementById('currentPageNum');
        const totalPageNum = document.getElementById('totalPageNum');
        const particleCanvas = document.getElementById('particleCanvas');
        const ctx = particleCanvas.getContext('2d');

        // ====================== 粒子背景（恢复电脑端效果） ======================
        function initParticleBackground() {
            // 手机端直接返回，不渲染粒子
            if (isMobile) return;
            
            // 电脑端恢复完整粒子效果
            const particleCount = Math.min(Math.floor(window.innerWidth / 10), 150);

            // 设置画布尺寸
            function resizeCanvas() {
                particleCanvas.width = window.innerWidth;
                particleCanvas.height = window.innerHeight;
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // 粒子类
            class Particle {
                constructor() {
                    this.x = Math.random() * particleCanvas.width;
                    this.y = Math.random() * particleCanvas.height;
                    this.size = Math.random() * 1.5 + 0.5;
                    this.speedX = Math.random() * 0.5 - 0.25;
                    this.speedY = Math.random() * 0.5 - 0.25;
                    this.color = 'rgba(79, 172, 254, 0.6)';
                }
                update() {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    // 边界回弹
                    if (this.x < 0 || this.x > particleCanvas.width) this.speedX = -this.speedX;
                    if (this.y < 0 || this.y > particleCanvas.height) this.speedY = -this.speedY;
                }
                draw() {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            // 创建粒子
            const particles = Array.from({ length: particleCount }, () => new Particle());

            // 动画循环（60fps）
            function animate() {
                ctx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
                particles.forEach(particle => {
                    particle.update();
                    particle.draw();
                });
                requestAnimationFrame(animate);
            }
            animate();
        }

        // ====================== 生成画廊（修复点击问题） ======================
        function renderGallery() {
            galleryContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();
            
            // 全端初始渲染所有项（避免滚动加载的性能问题）
            imgList.forEach((item, index) => {
                createGalleryItem(item, index, fragment);
            });
            
            galleryContainer.appendChild(fragment);
            totalPageNum.textContent = imgList.length;
        }

        // 创建画廊项（核心修复点击区域）
        function createGalleryItem(item, index, fragment) {
            const galleryItem = document.createElement('div');
            galleryItem.className = 'gallery-item';
            galleryItem.dataset.index = index;
            
            // 图片容器
            const imgWrapper = document.createElement('div');
            imgWrapper.className = 'gallery-img-wrapper loading';
            
            // 图片元素
            const img = document.createElement('img');
            // 优先使用缩略图，无则用原图
            const imgSrc = item.thumbSrc ? item.thumbSrc : item.src;
            img.src = imgSrc;
            img.alt = `作品${item.title}`;
            img.loading = 'eager'; // 改为立即加载，避免懒加载导致的卡顿
            img.dataset.index = index;
            img.dataset.originalSrc = item.src;
            
            // 图片加载完成
            img.onload = function() {
                imgWrapper.classList.remove('loading');
                img.classList.add('loaded');
                
                // 后台加载原图
                if (item.thumbSrc) {
                    const originalImg = new Image();
                    originalImg.src = item.src;
                    originalImg.onload = () => {
                        img.src = item.src;
                        img.dataset.loadedOriginal = 'true';
                    };
                }
                
                // 防盗
                this.oncontextmenu = () => false;
                this.oncopy = () => false;
            };
            
            // 图片加载失败
            img.onerror = function() {
                imgWrapper.classList.remove('loading');
                this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzIyMiIvPjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiNmZmYiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7nlLXorr7orr7mlL/nlYw8L3RleHQ+PC9zdmc+';
            };
            
            // 作品标题
            const title = document.createElement('div');
            title.className = 'item-title';
            title.textContent = item.title;
            
            // 组装DOM
            imgWrapper.appendChild(img);
            galleryItem.appendChild(imgWrapper);
            galleryItem.appendChild(title);
            fragment.appendChild(galleryItem);
            
            // 绑定点击事件（核心：直接绑定到galleryItem，确保整个区域可点击）
            galleryItem.addEventListener('click', (e) => {
                e.stopPropagation();
                currentIndex = index;
                openPreview();
            });
            
            // 绑定事件（区分端）
            if (isMobile) {
                bindMobileImgEvents(img, index);
            } else {
                bindImgEvents(img, false, index);
            }
        }

        // ====================== 预览模式控制 ======================
        function openPreview() {
            const item = imgList[currentIndex];
            const img = document.querySelector(`img[data-index="${currentIndex}"]`);
            const useOriginal = img && img.dataset.loadedOriginal === 'true';
            
            // 立即显示图片（优先用已加载的图）
            previewImg.src = useOriginal ? item.src : (item.thumbSrc ? item.thumbSrc : item.src);
            previewImg.style.transform = `translate(0px, 0px) scale(1)`;
            
            // 更新状态
            currentPageNum.textContent = currentIndex + 1;
            updateNavBtnStates();
            
            // 显示预览
            previewModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // 绑定预览事件
            if (isMobile) {
                bindMobileImgEvents(previewImg, currentIndex, true);
            } else {
                bindImgEvents(previewImg, true);
            }
            
            // 防盗
            previewImg.oncontextmenu = () => false;
            previewImg.oncopy = () => false;

            // 后台加载原图
            if (!useOriginal) {
                const originalImg = new Image();
                originalImg.src = item.src;
                originalImg.onload = () => {
                    previewImg.src = item.src;
                };
            }
        }

        function closePreview() {
            savePreviewImgState();
            previewModal.style.display = 'none';
            document.body.style.overflow = '';
        }

        function switchItem(direction) {
            savePreviewImgState();
            currentIndex += direction;
            currentIndex = Math.max(0, Math.min(imgList.length - 1, currentIndex));
            
            const item = imgList[currentIndex];
            previewImg.src = item.thumbSrc ? item.thumbSrc : item.src;
            previewImg.style.transform = `translate(0px, 0px) scale(1)`;
            
            currentPageNum.textContent = currentIndex + 1;
            updateNavBtnStates();

            // 后台加载原图
            const originalImg = new Image();
            originalImg.src = item.src;
            originalImg.onload = () => {
                previewImg.src = item.src;
            };
        }

        function updateNavBtnStates() {
            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex === imgList.length - 1;
        }

        // ====================== 图片交互事件（优化性能） ======================
        // 电脑端事件
        function bindImgEvents(img, isPreview = false, galleryIndex = null) {
            // 滚轮缩放（节流）
            let wheelTimer = null;
            function handleWheel(e) {
                e.preventDefault();
                if (wheelTimer) clearTimeout(wheelTimer);
                
                wheelTimer = setTimeout(() => {
                    const index = isPreview ? currentIndex : galleryIndex;
                    const state = imgStates[index];
                    
                    const scaleDelta = e.deltaY < 0 ? 0.1 : -0.1; // 减小缩放步长，更流畅
                    state.scale = Math.max(0.5, Math.min(4, state.scale + scaleDelta));
                    updateImgTransform(img, state);
                }, 8); // 更高帧率，更流畅
            }
            img.addEventListener('wheel', handleWheel, { passive: false });
            
            // 鼠标拖拽
            function handleMouseDown(e) {
                e.preventDefault();
                const index = isPreview ? currentIndex : galleryIndex;
                const state = imgStates[index];
                
                let startX = e.clientX - state.x;
                let startY = e.clientY - state.y;
                let isDragging = false;
                
                img.style.cursor = 'grabbing';
                
                function handleMouseMove(e) {
                    if (!isDragging) return;
                    state.x = e.clientX - startX;
                    state.y = e.clientY - startY;
                    updateImgTransform(img, state);
                }
                
                function handleMouseUp() {
                    isDragging = false;
                    img.style.cursor = 'grab';
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                }
                
                isDragging = true;
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            }
            img.addEventListener('mousedown', handleMouseDown);
        }

        // 移动端事件（简化）
        function bindMobileImgEvents(img, index, isPreview = false) {
            let isDragging = false;
            let touchStart = {};
            
            function handleTouchStart(e) {
                e.preventDefault();
                const realIndex = isPreview ? currentIndex : index;
                const state = imgStates[realIndex];
                const touches = e.touches;
                
                if (touches.length === 1) {
                    touchStart.x = touches[0].clientX - state.x;
                    touchStart.y = touches[0].clientY - state.y;
                    touchStart.startScale = state.scale;
                    isDragging = true;
                } else if (touches.length === 2) {
                    touchStart.distance = getTouchDistance(touches[0], touches[1]);
                    touchStart.scale = state.scale;
                }
            }
            
            function handleTouchMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                
                const realIndex = isPreview ? currentIndex : index;
                const state = imgStates[realIndex];
                const touches = e.touches;
                
                if (touches.length === 1) {
                    // 单指拖拽
                    state.x = touches[0].clientX - touchStart.x;
                    state.y = touches[0].clientY - touchStart.y;
                    img.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale})`;
                } else if (touches.length === 2) {
                    // 双指缩放
                    const distance = getTouchDistance(touches[0], touches[1]);
                    state.scale = Math.max(0.5, Math.min(3, touchStart.scale * (distance / touchStart.distance)));
                    img.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale})`;
                }
            }
            
            function handleTouchEnd() {
                isDragging = false;
            }
            
            // 绑定事件（只绑定一次）
            img.removeEventListener('touchstart', handleTouchStart);
            img.removeEventListener('touchmove', handleTouchMove);
            img.removeEventListener('touchend', handleTouchEnd);
            
            img.addEventListener('touchstart', handleTouchStart, { passive: false });
            img.addEventListener('touchmove', handleTouchMove, { passive: false });
            img.addEventListener('touchend', handleTouchEnd);
        }

        // 辅助函数
        function getTouchDistance(t1, t2) {
            const dx = t2.clientX - t1.clientX;
            const dy = t2.clientY - t1.clientY;
            return Math.sqrt(dx * dx + dy * dy) || 1;
        }

        function updateImgTransform(img, state) {
            if (!img || !state) return;
            img.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale})`;
        }

        function savePreviewImgState() {
            if (!previewImg.style.transform) return;
            
            const transform = previewImg.style.transform;
            const scaleMatch = transform.match(/scale\(([\d.]+)\)/);
            const xMatch = transform.match(/translate\(([\d.-]+)px,/);
            const yMatch = transform.match(/, ([\d.-]+)px\)/);
            
            if (scaleMatch && xMatch && yMatch) {
                imgStates[currentIndex].scale = parseFloat(scaleMatch[1]);
                imgStates[currentIndex].x = parseFloat(xMatch[1]);
                imgStates[currentIndex].y = parseFloat(yMatch[1]);
            }
        }

        // ====================== 防盗逻辑（简化，提升性能） ======================
        function initSecurity() {
            // 禁用快捷键（仅电脑端）
            if (!isMobile) {
                document.addEventListener('keydown', (e) => {
                    const forbiddenKeys = ['F12', 'u', 's', 'I'];
                    if (e.key === 'F12' || 
                        (e.ctrlKey && forbiddenKeys.includes(e.key)) || 
                        (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                        e.preventDefault();
                        return false;
                    }
                }, true);
            }

            // 简化防盗，只保留基础禁用
            setInterval(() => {
                document.body.oncontextmenu = () => false;
                document.body.onselectstart = () => false;
            }, 2000);
        }

        // ====================== 事件绑定 ======================
        function bindEvents() {
            // 预览按钮
            prevBtn.addEventListener('click', () => switchItem(-1));
            nextBtn.addEventListener('click', () => switchItem(1));
            closeBtn.addEventListener('click', closePreview);

            // 键盘控制（电脑端）
            if (!isMobile) {
                document.addEventListener('keydown', (e) => {
                    if (previewModal.style.display === 'flex') {
                        switch(e.key) {
                            case 'ArrowLeft': switchItem(-1); break;
                            case 'ArrowRight': switchItem(1); break;
                            case 'Escape': closePreview(); break;
                        }
                    }
                });
            }

            // 点击空白处关闭
            previewModal.addEventListener('click', (e) => {
                if (e.target === previewModal) closePreview();
            });

            // 移动端滑动关闭
            if (isMobile) {
                let touchStartX = 0;
                previewModal.addEventListener('touchstart', (e) => {
                    touchStartX = e.touches[0].clientX;
                });
                previewModal.addEventListener('touchend', (e) => {
                    const touchEndX = e.changedTouches[0].clientX;
                    if (touchEndX - touchStartX > 50) {
                        closePreview();
                    }
                });
            }
        }

        // ====================== 初始化 ======================
        window.addEventListener('DOMContentLoaded', () => {
            // 立即初始化，不延迟
            initParticleBackground();
            renderGallery();
            bindEvents();
            initSecurity();
            
            // 预加载前3张图片
            imgList.slice(0, 3).forEach(item => {
                const img = new Image();
                img.src = item.thumbSrc ? item.thumbSrc : item.src;
            });
        });
    </script>
</body>
</html>
